#!/bin/bash

### CHECK THE NUMBER OF COMNMAND LINE ARUGMENTS; 2 REQUIRED
if [ "$#" -lt "1"    -o "$1" == "-h" -o  "$1" == "-help" -o  "$1" == "--help" -o ! -d "$1" -o ! -f "$1/trace.csv" ] 
then
    name=`basename $0`
    echo "Usage: 
    $name DIR1 [DIR2] [DIR3] ...
    
The first argument is compulsory. 

DIRs must be valid gpmin experiment directories. 

"
    exit
fi



ROW_PATTERN="%-43s%-10s%-11s%-20s%-12s%-10s%-20s\n"

LINE='#'`printf %128s |tr " " "-"`'#'

echo $LINE
printf $ROW_PATTERN  '' '' 'DURATION' '' 'BEST' 'BEST' 'CANDIDATES '  
printf $ROW_PATTERN  'EXPERIMENT' 'STATUS' '(hh:mm)' 'LAST UPDATE' 'VALUE' 'JOB_ID' ': PENDING' 
printf $ROW_PATTERN  '' '' '' '' '' '' ': COMPLETED' 
echo $LINE

for dir in ${*:1}
do 
    if [ -d "$dir" -a -f "$dir/trace.csv" ] 
    then
        FIRST=($(head -n 1 $dir/trace.csv | tr ',' '\n'))
        STATUS=($(tail -n 1 $dir/trace.csv | tr ',' '\n'))
        hh=$(echo  "(${STATUS[0]} - ${FIRST[0]}) / 3600" | bc -l )
        mm=$(echo '0.'`echo "$hh" | cut -d '.' -f 2`" * 60" | bc -l | cut -d '.' -f 1 )
        if [ -z "$mm" ] 
        then 
            mm="00"
        fi
        if [ `expr length "$mm"` -lt 2 ] 
        then 
            mm="0"$mm
        fi
        hh=$(echo "$hh" | cut -d '.' -f 1)
        if [ -z "$hh" ] 
        then 
            hh="00"
        fi
         
        DIFF=$((`date +%s` - ${STATUS[0]}))
        if [ "$DIFF" -le "60" ] 
        then 
            STAT='RUNNING'
        elif [ "$DIFF" -ge "500" ]
        then
            STAT='STOPPED'
        else
            STAT='IDLE'
        fi

        #printf "%-10s\t%s\n"  
        printf $ROW_PATTERN "`basename $dir`" $STAT "$hh:$mm" "`date -d @${STATUS[0]} +"%Y.%m.%d %H:%M"`"  ${STATUS[1]}  ${STATUS[2]}  "${STATUS[3]} : ${STATUS[5]} : ${STATUS[4]}"
    fi
done
echo $LINE

